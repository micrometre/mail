---
- name: Install OpenSSL and Python cryptography dependencies
  apt:
    name:
      - openssl
      - python3-cryptography
      - python3-cffi
      - python3-dev
      - libffi-dev
      - libssl-dev
    state: present

- name: Create SSL certificate directory
  file:
    path: "{{ ssl_cert_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Generate self-signed certificates using OpenSSL commands
  block:
    - name: Generate private key using OpenSSL command
      shell: |
        openssl genrsa -out "{{ ssl_key_path }}" 2048
        chmod 600 "{{ ssl_key_path }}"
        chown root:root "{{ ssl_key_path }}"
      args:
        creates: "{{ ssl_key_path }}"

    - name: Create OpenSSL config file for certificate
      copy:
        content: |
          [req]
          distinguished_name = req_distinguished_name
          x509_extensions = v3_req
          prompt = no
          
          [req_distinguished_name]
          C = {{ ssl_country }}
          ST = {{ ssl_state }}
          L = {{ ssl_city }}
          O = {{ ssl_organization }}
          OU = {{ ssl_organizational_unit }}
          CN = {{ mail_domain }}
          emailAddress = {{ ssl_email }}
          
          [v3_req]
          keyUsage = keyEncipherment, dataEncipherment
          extendedKeyUsage = serverAuth
          subjectAltName = @alt_names
          
          [alt_names]
          DNS.1 = {{ mail_domain }}
          DNS.2 = mail.{{ mail_domain }}
          DNS.3 = localhost
          IP.1 = 127.0.0.1
        dest: "{{ ssl_cert_dir }}/openssl.cnf"
        owner: root
        group: root
        mode: '0644'

    - name: Generate self-signed certificate using OpenSSL command
      shell: |
        openssl req -new -x509 -key "{{ ssl_key_path }}" \
          -out "{{ ssl_cert_path }}" \
          -days {{ ssl_cert_days }} \
          -config "{{ ssl_cert_dir }}/openssl.cnf" \
          -extensions v3_req
        chmod 644 "{{ ssl_cert_path }}"
        chown root:root "{{ ssl_cert_path }}"
      args:
        creates: "{{ ssl_cert_path }}"

    - name: Remove temporary OpenSSL config file
      file:
        path: "{{ ssl_cert_dir }}/openssl.cnf"
        state: absent

  when: ssl_cert_type == "selfsigned"

- name: Set up Let's Encrypt certificates
  block:
    - name: Install Certbot
      apt:
        name:
          - certbot
          - python3-certbot-apache
        state: present

    - name: Generate Let's Encrypt certificate
      command: >
        certbot certonly --standalone
        --non-interactive
        --agree-tos
        --email {{ ssl_email }}
        -d {{ mail_domain }}
        -d mail.{{ mail_domain }}
      args:
        creates: "/etc/letsencrypt/live/{{ mail_domain }}/fullchain.pem"

    - name: Update certificate paths for Let's Encrypt
      set_fact:
        ssl_cert_path: "/etc/letsencrypt/live/{{ mail_domain }}/fullchain.pem"
        ssl_key_path: "/etc/letsencrypt/live/{{ mail_domain }}/privkey.pem"

  when: ssl_cert_type == "letsencrypt"

- name: Display certificate information
  debug:
    msg:
      - "SSL Certificate Type: {{ ssl_cert_type }}"
      - "Certificate Path: {{ ssl_cert_path }}"
      - "Private Key Path: {{ ssl_key_path }}"
      - "Certificate valid for: {{ ssl_cert_days }} days (self-signed only)"